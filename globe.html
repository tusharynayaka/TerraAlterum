<!--
This code creates a webpage that lets the user:

‚úî View a rotating 3D Earth
‚úî Search any city on Earth
‚úî Instantly zoom to that city
‚úî View its map
‚úî View live weather
‚úî Auto-refresh weather
‚úî Track the user‚Äôs live location
‚úî Show the user on the map
‚úî Display everything in a beautiful modal
-->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>City Globe Locator with Map & Weather</title>
    <script src="https://unpkg.com/globe.gl@2.27.0/dist/globe.gl.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: #0a0e27;
            color: white;
        }

        nav {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
        }

        nav ul {
            list-style: none;
            display: flex;
            justify-content: center;
            gap: 2rem;
            flex-wrap: wrap;
        }

        nav a {
            color: white;
            text-decoration: none;
            font-weight: 600;
            transition: opacity 0.3s ease;
        }

        nav a:hover {
            opacity: 0.8;
            text-decoration: underline;
        }

        #globe {
            width: 100vw;
            height: 100vh;
            display: block;
        }

        #controls {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 50;
            background: rgba(10, 14, 39, 0.95);
            padding: 20px 30px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(102, 126, 234, 0.3);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(102, 126, 234, 0.2);
            min-width: 350px;
        }

        #controls h2 {
            margin-bottom: 14px;
            color: #a78bfa;
        }

        #cityInput {
            width: 100%;
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid rgba(102, 126, 234, 0.4);
            background: rgba(255, 255, 255, 0.08);
            color: white;
            margin-bottom: 12px;
        }

        #searchBtn {
            width: 100%;
            padding: 10px 16px;
            border-radius: 8px;
            border: none;
            background: linear-gradient(90deg, #667eea, #764ba2);
            color: white;
            font-weight: 600;
            cursor: pointer;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 200;
        }

        .modal-overlay.active {
            display: block;
        }

        .modal {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 201;
            background: rgba(20, 25, 50, 0.98);
            border-radius: 16px;
            box-shadow: 0 -8px 32px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(102, 126, 234, 0.3);
            backdrop-filter: blur(10px);
            display: none;
            flex-direction: column;
            animation: slideFromCorner 0.4s ease;
            max-height: 75vh;
            height: 600px;
            width: 800px;
            max-width: calc(100vw - 40px);
        }

        .modal.active {
            display: flex;
        }

        @keyframes slideFromCorner {
            from {
                transform: translateX(-120%) translateY(120%);
                opacity: 0;
            }

            to {
                transform: translateX(0) translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid rgba(102, 126, 234, 0.2);
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.1rem;
            color: #a78bfa;
        }

        .close-btn {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            font-size: 24px;
            cursor: pointer;
        }

        .close-btn:hover {
            color: white;
        }

        .modal-content {
            display: flex;
            flex: 1;
            overflow: hidden;
            border-radius: 0 0 16px 16px;
        }

        #map {
            flex: 1;
        }

        #weather {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            color: white;
            border-radius: 0 0 16px 16px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: flex-start;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.8), rgba(118, 75, 162, 0.8));
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.3);
            transition: background 0.5s ease;
        }

        #weather h2 {
            margin-bottom: 20px;
            font-size: 1.4rem;
            color: #fffb;
        }

        .weather-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            width: 100%;
        }

        .weather-info div {
            background: rgba(255, 255, 255, 0.1);
            padding: 12px;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: center;
            transition: transform 0.2s;
        }

        .weather-info div:hover {
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.2);
        }

        .weather-info strong {
            display: block;
            margin-bottom: 4px;
            font-size: 14px;
            color: #ffd;
        }

        .weather-icon {
            font-size: 24px;
            margin-bottom: 4px;
        }

        #prediction-panel {
            position: fixed;
            top: 250px;
            right: 20px;
            z-index: 50;
            background: rgba(10, 14, 39, 0.9);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid rgba(102, 126, 234, 0.3);
            backdrop-filter: blur(8px);
            width: 250px;
            font-family: 'Rajdhani', sans-serif;
        }

        #prediction-panel h3 {
            color: #a78bfa;
            font-size: 1.1rem;
            margin-bottom: 10px;
        }

        .risk-row {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            font-size: 0.9rem;
        }

        .risk-val {
            font-weight: bold;
        }

        .risk-crit {
            color: #ef4444;
        }

        .risk-high {
            color: #f59e0b;
        }

        .risk-low {
            color: #10b981;
        }

        @media(max-width: 768px) {
            .modal {
                width: calc(100vw - 40px);
                height: 60vh;
                bottom: 10px;
                left: 10px;
                flex-direction: column;
            }

            .modal-content {
                flex-direction: column;
            }

            #map,
            #weather {
                height: 50%;
                width: 100%;
            }

            .weather-info {
                grid-template-columns: 1fr;
            }

            #prediction-panel {
                top: auto;
                bottom: 20px;
                right: 20px;
                width: 200px;
            }
        }
    </style>
</head>

<body>

    <nav>
        <ul></ul>
    </nav>
    <script src="/navigation.js"></script>

    <div id="controls">
        <h2>üåç Search Cities</h2>
        <input type="text" id="cityInput" placeholder="Enter city name (e.g., Paris, Tokyo)">
        <button id="searchBtn" onclick="searchCity()">Search</button>
    </div>

    <div id="globe"></div>

    <div id="prediction-panel">
        <h3>ü§ñ Disaster Risk ML</h3>
        <div class="risk-row">
            <span>Risk Level:</span>
            <span id="risk-level" class="risk-val">Calculating...</span>
        </div>
        <div class="risk-row">
            <span>Probability:</span>
            <span id="risk-prob" class="risk-val">--%</span>
        </div>
        <div class="risk-row">
            <span>Will Occur:</span>
            <span id="will-occur" class="risk-val">--</span>
        </div>
    </div>

    <div class="modal-overlay" id="modalOverlay"></div>
    <div class="modal" id="mapModal">
        <div class="modal-header">
            <h3 id="mapTitle">üìç Location Map & Weather</h3>
            <button class="close-btn" onclick="closeMap()">&times;</button>
        </div>
        <div class="modal-content">
            <div id="map"></div>
            <div id="weather">Loading weather...</div>
        </div>
    </div>

    <script>
        const globe = Globe()
            .globeImageUrl('//unpkg.com/three-globe/example/img/earth-blue-marble.jpg')
            .backgroundImageUrl('//unpkg.com/three-globe/example/img/night-sky.png')
            .width(window.innerWidth)
            .height(window.innerHeight)
            (document.getElementById('globe'));

        globe.controls().autoRotate = true;
        globe.controls().autoRotateSpeed = 0.5;

        const defaultLabels = [
            { lat: 40.7128, lng: -74.0060, text: 'New York' },
            { lat: 51.5074, lng: -0.1278, text: 'London' },
            { lat: 48.8566, lng: 2.3522, text: 'Paris' },
            { lat: 35.6762, lng: 139.6503, text: 'Tokyo' },
            { lat: -33.8688, lng: 151.2093, text: 'Sydney' }
        ];
        globe.labelsData(defaultLabels).labelText('text').labelColor('white').labelSize(1.5);

        let map, marker;
        function openMapModal() {
            document.getElementById('mapModal').classList.add('active');
            document.getElementById('modalOverlay').classList.add('active');
            // Initialize the Leaflet map synchronously so callers can use `map` immediately.
            if (!map) {
                map = L.map('map').setView([0, 0], 2);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬©Ô∏è OpenStreetMap contributors' }).addTo(map);
            }
            // allow layout to settle then refresh size
            setTimeout(() => { if (map) map.invalidateSize(); }, 100);
        }
        function closeMap() {
            document.getElementById('mapModal').classList.remove('active');
            document.getElementById('modalOverlay').classList.remove('active');
            // stop periodic weather updates and remove the marker
            if (weatherIntervalId) { clearInterval(weatherIntervalId); weatherIntervalId = null; }
            if (marker && map) { try { map.removeLayer(marker); } catch (e) { } marker = null; }
        }
        document.getElementById('modalOverlay').addEventListener('click', closeMap);

        const API_KEY = 'e15ee20095f1ca448fd5782b1d106790';
        let liveWatchId = null;
        let weatherIntervalId = null;
        let lastKnown = { lat: null, lon: null, name: null };

        function getWeatherIcon(condition) {
            condition = condition.toLowerCase();
            if (condition.includes('cloud')) return '‚òÅÔ∏è';
            if (condition.includes('rain') || condition.includes('drizzle')) return 'üåßÔ∏è';
            if (condition.includes('clear')) return '‚òÄÔ∏è';
            if (condition.includes('snow')) return '‚ùÑÔ∏è';
            return 'üå§Ô∏è';
        }

        async function searchCity() {
            const city = document.getElementById('cityInput').value.trim();
            if (!city) { alert('Enter a city'); return; }

            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city)}&limit=1`);
                const data = await response.json();
                if (data.length === 0) { alert('City not found'); return; }

                const lat = parseFloat(data[0].lat);
                const lon = parseFloat(data[0].lon);
                const name = data[0].display_name.split(',')[0];

                globe.pointOfView({ lat, lng: lon, altitude: 0.5 }, 2000);
                globe.controls().autoRotate = false;
                globe.labelsData([...defaultLabels, { lat, lng: lon, text: name }]);

                openMapModal();
                document.getElementById('mapTitle').textContent = `üìç ${data[0].display_name}`;
                if (marker) map.removeLayer(marker);
                map.setView([lat, lon], 12);
                marker = L.marker([lat, lon]).addTo(map).bindPopup(data[0].display_name).openPopup();

                const weatherResp = await fetch(`/api/weather?lat=${lat}&lon=${lon}`);
                const weather = await weatherResp.json();
                const weatherPanel = document.getElementById('weather');

                const icon = getWeatherIcon(weather.weather[0].main);

                weatherPanel.innerHTML = `
            <h2>${name}</h2>
            <div class="weather-info">
                <div><div class="weather-icon">${icon}</div><strong>Condition</strong>${weather.weather[0].description}</div>
                <div><div class="weather-icon">üå°Ô∏è</div><strong>Temperature</strong>${weather.main.temp} ¬∞C</div>
                <div><div class="weather-icon">ü•∂</div><strong>Feels Like</strong>${weather.main.feels_like} ¬∞C</div>
                <div><div class="weather-icon">üíß</div><strong>Humidity</strong>${weather.main.humidity}%</div>
                <div><div class="weather-icon">üí®</div><strong>Wind</strong>${weather.wind.speed} m/s</div>
            </div>
        `;

                // Update ML Prediction
                updateMLPrediction(weather.main.temp, weather.main.humidity, weather.main.pressure);

                // Dynamic background
                const cond = weather.weather[0].main.toLowerCase();
                if (cond.includes('cloud')) weatherPanel.style.background = 'linear-gradient(135deg, #757f9a, #d7dde8)';
                else if (cond.includes('rain') || cond.includes('drizzle')) weatherPanel.style.background = 'linear-gradient(135deg, #4b79a1, #283e51)';
                else if (cond.includes('clear')) weatherPanel.style.background = 'linear-gradient(135deg, #f7971e, #ffd200)';
                else if (cond.includes('snow')) weatherPanel.style.background = 'linear-gradient(135deg, #83a4d4, #b6fbff)';
                else weatherPanel.style.background = 'linear-gradient(135deg, rgba(102,126,234,0.8), rgba(118,75,162,0.8))';

                // store last known position
                lastKnown.lat = lat; lastKnown.lon = lon; lastKnown.name = name;

                // start periodic weather updates (every 2 minutes) while modal is open
                if (weatherIntervalId) clearInterval(weatherIntervalId);
                weatherIntervalId = setInterval(() => fetchAndUpdateWeather(lastKnown.lat, lastKnown.lon, lastKnown.name), 120000);

            } catch (err) {
                console.error(err);
                alert('Error fetching data');
            }
        }

        document.getElementById('cityInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') searchCity(); });

        async function updateMLPrediction(temp, humidity, pressure) {
            try {
                const res = await fetch('/api/predict', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ temp, humidity, pressure })
                });
                const data = await res.json();

                const levelEl = document.getElementById('risk-level');
                levelEl.innerText = data.risk_level;
                levelEl.className = 'risk-val ' + (data.risk_level === 'CRITICAL' ? 'risk-crit' : data.risk_level === 'HIGH' ? 'risk-high' : 'risk-low');

                document.getElementById('risk-prob').innerText = data.probability;
                document.getElementById('will-occur').innerText = data.will_occur;
            } catch (e) {
                console.error('ML update failed', e);
            }
        }

        async function fetchAndUpdateWeather(lat, lon, name) {
            if (!lat || !lon) return;
            try {
                const weatherResp = await fetch(`/api/weather?lat=${lat}&lon=${lon}`);
                const weather = await weatherResp.json();
                const weatherPanel = document.getElementById('weather');
                if (!weather || !weather.weather) return;
                const icon = getWeatherIcon(weather.weather[0].main);
                weatherPanel.innerHTML = `
            <h2>${name || 'Location'}</h2>
            <div class="weather-info">
                <div><div class="weather-icon">${icon}</div><strong>Condition</strong>${weather.weather[0].description}</div>
                <div><div class="weather-icon">\ud83c\udf21\ufe0f</div><strong>Temperature</strong>${weather.main.temp} \u00b0C</div>
                <div><div class="weather-icon">\ud83e\udd76</div><strong>Feels Like</strong>${weather.main.feels_like} \u00b0C</div>
                <div><div class="weather-icon">\ud83d\udca7</div><strong>Humidity</strong>${weather.main.humidity}%</div>
                <div><div class="weather-icon">\ud83d\udca8</div><strong>Wind</strong>${weather.wind.speed} m/s</div>
            </div>
        `;

                updateMLPrediction(weather.main.temp, weather.main.humidity, weather.main.pressure);

                const cond = weather.weather[0].main.toLowerCase();
                if (cond.includes('cloud')) weatherPanel.style.background = 'linear-gradient(135deg, #757f9a, #d7dde8)';
                else if (cond.includes('rain') || cond.includes('drizzle')) weatherPanel.style.background = 'linear-gradient(135deg, #4b79a1, #283e51)';
                else if (cond.includes('clear')) weatherPanel.style.background = 'linear-gradient(135deg, #f7971e, #ffd200)';
                else if (cond.includes('snow')) weatherPanel.style.background = 'linear-gradient(135deg, #83a4d4, #b6fbff)';
                else weatherPanel.style.background = 'linear-gradient(135deg, rgba(102,126,234,0.8), rgba(118,75,162,0.8))';

            } catch (err) { console.warn('Weather fetch failed', err); }
        }

        // Watch user's position and update globe/map in real time
        function startLiveTracking() {
            if (!navigator.geolocation) return;
            if (liveWatchId !== null) return; // already watching
            liveWatchId = navigator.geolocation.watchPosition(pos => {
                const lat = pos.coords.latitude; const lon = pos.coords.longitude;
                lastKnown.lat = lat; lastKnown.lon = lon; lastKnown.name = 'You';
                globe.pointOfView({ lat, lng: lon, altitude: 0.5 }, 1200);
                globe.controls().autoRotate = false;
                // if map modal open, update map & marker & weather
                if (document.getElementById('mapModal').classList.contains('active')) {
                    if (!map) {
                        map = L.map('map').setView([lat, lon], 12);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '\u00a9\ufe0f OpenStreetMap contributors' }).addTo(map);
                    }
                    if (marker) map.removeLayer(marker);
                    marker = L.marker([lat, lon]).addTo(map).bindPopup('You are here').openPopup();
                    map.setView([lat, lon], 12);
                    fetchAndUpdateWeather(lat, lon, 'You');
                    if (weatherIntervalId) clearInterval(weatherIntervalId);
                    weatherIntervalId = setInterval(() => fetchAndUpdateWeather(lat, lon, 'You'), 120000);
                }
            }, err => {
                console.warn('Live geolocation failed', err);
            }, { enableHighAccuracy: true, maximumAge: 5000, timeout: 10000 });
        }

        // Stop live tracking
        function stopLiveTracking() {
            if (liveWatchId !== null && navigator.geolocation) navigator.geolocation.clearWatch(liveWatchId);
            liveWatchId = null;
            if (weatherIntervalId) { clearInterval(weatherIntervalId); weatherIntervalId = null; }
        }

        // Start live tracking automatically (best-effort, will prompt user)
        startLiveTracking();
    </script>

</body>

</html>